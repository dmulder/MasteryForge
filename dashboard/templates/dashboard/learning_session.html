{% extends "base.html" %}

{% block title %}Learning Session - KinderForge{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 1.5rem auto;">
    <h2>{{ concept.title }}</h2>
    <p style="margin: 0.5rem 0 1.5rem; color: #5f6c72;">Stay focused. Your next step is ready.</p>

    {% if encouragement %}
    <div style="background: #fff7e6; border: 1px solid #ffe2b0; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <strong>Encouragement:</strong> {{ encouragement }}
    </div>
    {% endif %}

    <div style="margin-bottom: 1.5rem;">
        <div class="progress-bar">
            <div class="progress-bar-fill" style="width: {{ mastery_percentage }}%;">
                {{ mastery_percentage|floatformat:0 }}%
            </div>
        </div>
        <p style="font-size: 0.9rem; color: #7f8c8d;">Current mastery</p>
    </div>

    {% if videos %}
    {% for video in videos %}
    <div style="margin-bottom: 1.5rem;">
        <p style="margin-bottom: 0.5rem; font-weight: 600;">{{ video.title }}</p>
        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px;">
            <iframe
                title="{{ video.title }}"
                src="https://www.khanacademy.org/embed_video?v={{ video.youtube_id }}"
                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"
                allow="fullscreen; encrypted-media"
                allowfullscreen>
            </iframe>
        </div>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">
            <a href="{{ video.khan_url }}" target="_blank" rel="noopener noreferrer">Open on Khan Academy</a>
        </p>
    </div>
    {% endfor %}
    {% else %}
    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px dashed #cbd5e1;">
        <p>Video not available yet for this lesson.</p>
    </div>
    {% endif %}

    <div style="margin-top: 2rem;">
        <button class="btn" id="mark-complete">Mark Lesson Complete</button>
    </div>
</div>

<div class="card" id="quiz-card" style="max-width: 900px; margin: 1.5rem auto; display: none;">
    <h2>Quick Check</h2>
    <p style="margin-bottom: 1rem;">Complete the quiz and enter your score to keep moving.</p>
    {% if quiz_url %}
    <div style="margin-bottom: 1.5rem;">
        <iframe
            title="Khan Quiz"
            src="{{ quiz_url }}"
            style="width: 100%; height: 560px; border: 1px solid #e2e8f0; border-radius: 8px;"
            sandbox="allow-scripts allow-same-origin allow-forms">
        </iframe>
    </div>
    {% endif %}
    <form method="post" action="{% url 'submit_quiz_result' %}">
        {% csrf_token %}
        <input type="hidden" name="concept_id" value="{{ concept.id }}">
        <div style="margin-bottom: 1rem;">
            <label for="score_percent" style="display: block; margin-bottom: 0.5rem;">Score (%)</label>
            <input type="number" min="0" max="100" name="score_percent" id="score_percent" required
                   style="width: 160px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
        </div>
        <button type="submit" class="btn">Submit Score</button>
    </form>
</div>

<script>
    const completeButton = document.getElementById('mark-complete');
    const quizCard = document.getElementById('quiz-card');
    if (completeButton && quizCard) {
        completeButton.addEventListener('click', () => {
            quizCard.style.display = 'block';
            quizCard.scrollIntoView({ behavior: 'smooth' });
        });
    }

    if (quizCard) {
        setTimeout(() => {
            quizCard.style.display = 'block';
        }, 180000);
    }
</script>
{% endblock %}
