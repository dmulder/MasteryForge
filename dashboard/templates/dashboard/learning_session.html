{% extends "base.html" %}

{% block title %}Learning Session - KinderForge{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 1.5rem auto;">
    <h2>{{ concept.title }}</h2>
    <p style="margin: 0.5rem 0 1.5rem; color: #5f6c72;">Stay focused. Your next step is ready.</p>

    {% if encouragement %}
    <div style="background: #fff7e6; border: 1px solid #ffe2b0; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <strong>Encouragement:</strong> {{ encouragement }}
    </div>
    {% endif %}

    <div style="margin-bottom: 1.5rem;">
        <div class="progress-bar">
            <div class="progress-bar-fill" style="width: {{ mastery_percentage }}%;">
                {{ mastery_percentage|floatformat:0 }}%
            </div>
        </div>
        <p style="font-size: 0.9rem; color: #7f8c8d;">Current mastery</p>
    </div>

    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px dashed #cbd5e1;">
        <p>Lesson videos will autoplay in full screen. If autoplay is blocked, tap anywhere on the video to start.</p>
    </div>
</div>

{% if videos %}
<section id="video-stage" style="position: relative; width: 100vw; height: 100vh; margin: 0;">
    <div style="position: absolute; inset: 0; background: #0b0b0f;"></div>
    <div style="position: absolute; inset: 0; display: flex; flex-direction: column;">
        <div style="padding: 0.75rem 1.25rem; color: #f8fafc; background: linear-gradient(180deg, rgba(11,11,15,0.8), rgba(11,11,15,0));">
            <div style="font-size: 0.9rem; opacity: 0.8;">Lesson videos</div>
            <div id="video-title" style="font-size: 1.1rem; font-weight: 600;">Starting…</div>
            <div id="video-count" style="font-size: 0.85rem; opacity: 0.75;">&nbsp;</div>
        </div>
        <div id="player-shell" style="flex: 1; position: relative;">
            <div id="player" style="position: absolute; inset: 0;"></div>
            <style>
                #player iframe {
                    width: 100% !important;
                    height: 100% !important;
                }
            </style>
        </div>
        <div style="padding: 0.75rem 1.25rem; display: flex; gap: 0.75rem; align-items: center; justify-content: space-between; background: linear-gradient(0deg, rgba(11,11,15,0.85), rgba(11,11,15,0));">
            <button class="btn" id="unmute" type="button">Unmute</button>
            <button class="btn" id="skip-videos" type="button" style="background: transparent; border: 1px solid #cbd5e1; color: #f8fafc;">Skip to practice</button>
        </div>
    </div>
    <div id="unmute-overlay" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(11, 11, 15, 0.65); backdrop-filter: blur(2px);">
        <button class="btn" id="unmute-overlay-button" type="button" style="font-size: 1.1rem; padding: 0.85rem 1.5rem;">Tap to unmute</button>
    </div>
    <div id="video-dom-data" style="display: none;">
        {% for video in videos %}
        <div class="video-item" data-youtube-id="{{ video.youtube_id }}" data-title="{{ video.title|escapejs }}"></div>
        {% endfor %}
    </div>
</section>
{% endif %}

<div class="card" id="quiz-card" style="max-width: 900px; margin: 1.5rem auto; display: none;">
    <h2>Practice Problems</h2>
    <p style="margin-bottom: 1rem;">Complete the practice problems and enter your score to keep moving.</p>
    {% if quiz_url %}
    <div id="practice-popup-status" style="margin-bottom: 1rem; color: #0f172a;">
        Opening practice problems…
    </div>
    <div id="practice-popup-fallback" style="display: none; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
        <a class="btn" href="{{ quiz_url }}" target="_blank" rel="noopener noreferrer">Open in new tab</a>
        <button class="btn" id="open-practice-popup" type="button" style="background: transparent; border: 1px solid #1d4ed8; color: #1d4ed8;">Try popup again</button>
        <span style="font-size: 0.85rem; color: #64748b;">If your browser blocks popups, use the new tab button.</span>
    </div>
    {% endif %}
    <form method="post" action="{% url 'submit_quiz_result' %}">
        {% csrf_token %}
        <input type="hidden" name="concept_id" value="{{ concept.id }}">
        <div style="margin-bottom: 1rem;">
            <label for="score_percent" style="display: block; margin-bottom: 0.5rem;">Score (%)</label>
            <input type="number" min="0" max="100" name="score_percent" id="score_percent" required
                   style="width: 160px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
        </div>
        <button type="submit" class="btn">Submit Score</button>
    </form>
</div>

{{ video_payload|json_script:"video-data" }}
{{ quiz_url|default_if_none:""|json_script:"quiz-url-data" }}
<script>
    const quizCard = document.getElementById('quiz-card');
    const videoStage = document.getElementById('video-stage');
    const videoTitle = document.getElementById('video-title');
    const videoCount = document.getElementById('video-count');
    const playerShell = document.getElementById('player-shell');
    const unmuteButton = document.getElementById('unmute');
    const unmuteOverlay = document.getElementById('unmute-overlay');
    const unmuteOverlayButton = document.getElementById('unmute-overlay-button');
    const skipButton = document.getElementById('skip-videos');
    const practicePopupStatus = document.getElementById('practice-popup-status');
    const practicePopupFallback = document.getElementById('practice-popup-fallback');
    const practicePopupButton = document.getElementById('open-practice-popup');
    const practiceUrl = JSON.parse(document.getElementById('quiz-url-data')?.textContent || '\"\"');
    let videos = JSON.parse(document.getElementById('video-data')?.textContent || '[]');
    if (!Array.isArray(videos)) {
        videos = [];
    }

    if (!videos.length) {
        const domItems = Array.from(document.querySelectorAll('#video-dom-data .video-item'));
        videos = domItems.map((item) => ({
            youtube_id: item.dataset.youtubeId,
            title: item.dataset.title,
        })).filter((item) => item.youtube_id);
    }

    let player = null;
    let currentIndex = 0;

    const resizePlayer = () => {
        if (!player) {
            return;
        }
        const target = playerShell || videoStage;
        if (!target) {
            return;
        }
        const rect = target.getBoundingClientRect();
        if (rect.width && rect.height) {
            player.setSize(rect.width, rect.height);
        }
    };

    let quizShown = false;
    const showQuiz = () => {
        if (quizShown) {
            return;
        }
        quizShown = true;
        if (videoStage) {
            videoStage.remove();
        }
        if (quizCard) {
            quizCard.style.display = 'block';
            quizCard.scrollIntoView({ behavior: 'smooth' });
        }
        if (practiceUrl) {
            const popup = window.open(practiceUrl, 'practiceProblems', 'width=1100,height=800,noopener,noreferrer');
            if (!popup) {
                if (practicePopupStatus) {
                    practicePopupStatus.textContent = 'Popup blocked. Use the options below to open practice problems.';
                    practicePopupStatus.style.color = '#b91c1c';
                }
                if (practicePopupFallback) {
                    practicePopupFallback.style.display = 'flex';
                }
            } else if (practicePopupStatus) {
                practicePopupStatus.textContent = 'Practice problems opened in a popup.';
            }
        }
    };

    const updateVideoMeta = () => {
        if (!videos.length) {
            return;
        }
        const current = videos[currentIndex];
        if (videoTitle) {
            videoTitle.textContent = current.title || 'Lesson video';
        }
        if (videoCount) {
            videoCount.textContent = `Video ${currentIndex + 1} of ${videos.length}`;
        }
    };

    const playNextVideo = () => {
        currentIndex += 1;
        if (currentIndex >= videos.length) {
            showQuiz();
            return;
        }
        updateVideoMeta();
        player.loadVideoById(videos[currentIndex].youtube_id);
    };

    window.onYouTubeIframeAPIReady = () => {
        if (!videos.length || !videoStage) {
            showQuiz();
            return;
        }
        videoStage.scrollIntoView({ behavior: 'smooth' });
        updateVideoMeta();
        player = new YT.Player('player', {
            width: '100%',
            height: '100%',
            videoId: videos[0].youtube_id,
            playerVars: {
                autoplay: 1,
                controls: 1,
                rel: 0,
                modestbranding: 1,
                playsinline: 1,
                enablejsapi: 1,
            },
            events: {
                onReady: (event) => {
                    try {
                        event.target.mute();
                        event.target.playVideo();
                        resizePlayer();
                    } catch (err) {
                        console.warn('Autoplay blocked', err);
                    }
                },
                onStateChange: (event) => {
                    if (event.data === YT.PlayerState.ENDED) {
                        playNextVideo();
                    }
                }
            }
        });
    };

    if (unmuteButton) {
        unmuteButton.addEventListener('click', () => {
            if (player && player.unMute) {
                player.unMute();
                player.setVolume(100);
                if (unmuteOverlay) {
                    unmuteOverlay.remove();
                }
            }
        });
    }

    if (unmuteOverlayButton) {
        unmuteOverlayButton.addEventListener('click', () => {
            if (player && player.unMute) {
                player.unMute();
                player.setVolume(100);
            }
            if (unmuteOverlay) {
                unmuteOverlay.remove();
            }
        });
    }

    if (skipButton) {
        skipButton.addEventListener('click', showQuiz);
    }

    if (practicePopupButton && practiceUrl) {
        practicePopupButton.addEventListener('click', () => {
            const popup = window.open(practiceUrl, 'practiceProblems', 'width=1100,height=800,noopener,noreferrer');
            if (!popup) {
                if (practicePopupStatus) {
                    practicePopupStatus.textContent = 'Popup blocked. Use the new tab button.';
                    practicePopupStatus.style.color = '#b91c1c';
                }
            }
        });
    }

    if (!videoStage) {
        showQuiz();
    }

    window.addEventListener('resize', resizePlayer);
</script>
<script src="https://www.youtube.com/iframe_api"></script>
{% endblock %}
